<html>
<head>
  <style type="text/css">
  </style>
  <script type="text/javascript" src="../lib/fabric.js"></script>
  <!-- script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.0/fabric.min.js" -->
  <script type="text/javascript" src="../lib/jquery-3.min.js"></script>
  <script type="text/javascript" src="../lib/filesaver.min.js"></script>
  <script type="text/javascript" src="../lib/templates.js"></script>
</head>
<body>
      <canvas id="c" width="300" height="500"></canvas>
      <img id="design1" class="img ui-draggable" data-src="/images/0002.png" alt="0002.png" src="http://res.cloudinary.com/dwo2xbukk/image/upload/v1504065877/0002_gtb0u5.svg" crossorigin="anonymous">
</body>
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script type="text/javascript">
(function() {

  var img02URL = 'http://fabricjs.com/lib/pug.jpg';
  var canvas = this.__canvas = new fabric.Canvas('c');
  // canvas.setBackgroundImage('http://res.cloudinary.com/dwo2xbukk/image/upload/v1504065786/iphone-5_yjpaox.png', canvas.renderAll.bind(canvas))
  fabric.Object.prototype.transparentCorners = false;
  var rects = []

  var drawingRect = insetRect({left: 0, top: 0, width: canvas.width, height: canvas.height}, 20)
  
  var drawingCanvas = new fabric.Rect({
    originX: 'left',
    originY: 'top',
    left: 0,
    top: 0,
    width: canvas.width,
    height: canvas.height,
    fill: 'red',
    selectable: true,
    lockScalingX: true,
    lockScalingY: true,
    lockMovementX: true,
    lockMovementY: true
  })

  canvas.add(drawingCanvas)

  var drawingRectCanvas = new fabric.Rect({
    originX: 'left',
    originY: 'top',
    left: drawingRect.left,
    top: drawingRect.top,
    width: drawingRect.width,
    height: drawingRect.height,
    fill: 'blue',
    selectable: true,
    lockScalingX: true,
    lockScalingY: true,
    lockMovementX: true,
    lockMovementY: true
  })

  canvas.add(drawingRectCanvas)

  var transformedLogicalPolygonCanvasHeight;
  var transformedLogicalPolygonCanvasWidth;

  var scale=1

  if(drawingRect.width > drawingRect.height) {
    transformedLogicalPolygonCanvasHeight = drawingRect.height
    transformedLogicalPolygonCanvasWidth = (logicalSpace.canvasWidth * drawingRect.height) / logicalSpace.canvasHeight
    scale = transformedLogicalPolygonCanvasWidth / logicalSpace.canvasWidth
  } else {
    transformedLogicalPolygonCanvasHeight = (logicalSpace.canvasHeight * drawingRect.width) / logicalSpace.canvasWidth
    transformedLogicalPolygonCanvasWidth = drawingRect.width
    scale =  transformedLogicalPolygonCanvasHeight / logicalSpace.canvasHeight
  }
  
  var polygonCanvasRect = centerInsideRect(drawingRect, transformedLogicalPolygonCanvasWidth, transformedLogicalPolygonCanvasHeight)

  var polygonCanvas = new fabric.Rect({
    originX: 'left',
    originY: 'top',
    left: polygonCanvasRect.left,
    top: polygonCanvasRect.top,
    width: polygonCanvasRect.width,
    height: polygonCanvasRect.height,
    fill: 'yellow',
    selectable: true,
    lockScalingX: true,
    lockScalingY: true,
    lockMovementX: true,
    lockMovementY: true
  })

  canvas.add(polygonCanvas)

  var tx = polygonCanvasRect.left
  var ty = polygonCanvasRect.top

  var templates = logicalSpace.templates
  var template = templates.find(function(element){
    return element.name == 'simple_2_rect_grid'
  })
  var polygons = template.polygons
  for(var i=0; i< polygons.length-1; i++){
    var polygon = polygons[i]
    var rect = new fabric.Rect({
        originX: 'left',
        originY: 'top',
        left: polygon.left*scale + tx,
        top: polygon.top*scale + ty,
        width: polygon.width * scale,
        height: polygon.height * scale ,
        fill: polygon.color,
        selectable: false,
        lockScalingX: true,
        lockScalingY: true,
        lockMovementX: true,
        lockMovementY: true,
        clipFor: 'pug'
      })

    rects.push(rect)
    canvas.add(rect)

    function clipByName(ctx){
              console.warn('hi')
              var scaleXTo1 = (1 / this.scaleX);
              var scaleYTo1 = (1 / this.scaleY);
              ctx.save();
              ctx.translate(-this.width/2,-this.height/2);
              //ctx.translate(0,0)
              if (this.getFlipY() && !this.getFlipX()){
                ctx.scale(scaleXTo1, -scaleYTo1);
              } else if (this.getFlipX() && !this.getFlipY()){
                ctx.scale(-scaleXTo1, scaleYTo1);
              } else if (this.getFlipX() && this.getFlipY()){
                ctx.scale(-scaleXTo1, -scaleYTo1);
              } else {
                ctx.scale(scaleXTo1, scaleYTo1);
              }
              ctx.rotate((this.angle * -1) * (Math.PI / 180));
              ctx.beginPath()
              ctx.fillStyle='cyan'
              ctx.rect(
                 
                            0, 0,
                          rects[0].width,
                          rects[0].height
                      );
              ctx.closePath()
              ctx.restore()
             }

       var pugImg = new Image();
       pugImg.onload = function (img) { 
      var pug = new fabric.Image(pugImg, {
         top: 150 ,
         left: 100,
         scaleX: 0.25,
         scaleY: 0.25,
         clipName: 'pug',
         clipTo: function(ctx){
          return clipByName.bind(pug)(ctx)
         }
        });
        // img1 = oImg
        // canvas.add(oImg);
        // canvas.renderAll();

        // var points = []
        // points.push({x: rects[0].left+rects[0].width, y: rects[0].top})
        // points.push({x: oImg.left+oImg.width, y: oImg.top})
        // points.push({x: oImg.left+oImg.width, y: oImg.top + oImg.height})
        // points.push({x: oImg.left, y: oImg.top + oImg.height})
        // points.push({x: oImg.left, y: rects[0].top + rects[0].height})
        // points.push({x: rects[0].left+rects[0].width, y: rects[0].top + rects[0].height})

        // var polygon = new fabric.Polygon(points, {
        //   top: rects[0].top,
        //   left: rects[0].left,
        //   selectable: true,

        // })

        //canvas.add(polygon)

        canvas.add(pug);
      }
      pugImg.src = img02URL
      //'http://res.cloudinary.com/dwo2xbukk/image/upload/v1504505680/pug_tfhm3g.jpg';

  }

  function insetRect(rect, insetDistance) {
    var newWidth = rect.width - 2*insetDistance;
    var newHeight = rect.height - 2*insetDistance;
    var newLeft = rect.left + insetDistance;
    var newTop = rect.top + insetDistance;
    return {left: newLeft, top: newTop, width: newWidth, height: newHeight}
  }

  //assumes that source rect is greater than destination
  function centerInsideRect(sourceRect, destinationWidth, destinationHeight) {
    var center = rectCenter(sourceRect)
    var newLeft = center.x - destinationWidth / 2;
    var newTop = center.y - destinationHeight / 2;
    return {left: newLeft, top: newTop, width: destinationWidth, height: destinationHeight}
  }

  function rectCenter(rect) {
    return {
      x: rect.left + (rect.width / 2),
      y: rect.top + (rect.height / 2),
    }
  }

  // $('#design1').on('click', function(e){
  //   fabric.Image.fromURL('http://res.cloudinary.com/dwo2xbukk/image/upload/v1504505680/pug_tfhm3g.jpg', function(oImg) {
  //     oImg.set({
  //      top: rects[0].top,
  //      left: rects[0].left,
  //     })
  //     // img1 = oImg
  //     canvas.add(oImg);

  //     var points = []
  //     points.push({x: rects[0].left+rects[0].width, y: rects[0].top})
  //     points.push({x: oImg.left+oImg.width, y: oImg.top})
  //     points.push({x: oImg.left+oImg.width, y: oImg.top + oImg.height})
  //     points.push({x: oImg.left, y: oImg.top + oImg.height})
  //     points.push({x: oImg.left, y: rects[0].top + rects[0].height})
  //     points.push({x: rects[0].left+rects[0].width, y: rects[0].top + rects[0].height})

  //     var polygon = new fabric.Polygon(points, {
  //       top: rects[0].top,
  //       left: rects[0].left,
  //       selectable: true,
  //     })

  //     //canvas.add(polygon)
  //   }, { crossOrigin: 'Anonymous' });
  // })
 
})();
</script>